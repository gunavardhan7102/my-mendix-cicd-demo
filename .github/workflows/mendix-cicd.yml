- name: Trigger Mendix Build and Wait for Completion
  id: mendix_build
  run: |
    echo "Starting Mendix build for AppId: ${{ secrets.MENDIX_APP_ID }}"

    # Make a POST request to the Mendix Build API to start a new build
    # We now pass the revision (commit ID) and a version number.
    BUILD_RESPONSE=$(curl --request POST 'https://deploy.mendix.com/api/1/apps/${{ secrets.MENDIX_APP_ID }}/packages' \
      --header 'Content-Type: application/json' \
      --header 'Mendix-Username: ${{ secrets.MENDIX_USERNAME }}' \
      --header 'Mendix-ApiKey: ${{ secrets.MENDIX_API_KEY }}' \
      --data-raw '{
          "branch": "main",
          "revision": "${{ github.sha }}",
          "version": "1.0.0.0"
      }')
    
    echo "Build triggered. Response: ${BUILD_RESPONSE}"
    
    # We use 'jq' to parse the JSON response and get the 'id' of the new build package
    build_id=$(echo "${BUILD_RESPONSE}" | jq -r '.id')
    
    # Check if a build ID was returned. If not, something went wrong.
    if [ "$build_id" == "null" ] || [ "$build_id" == "" ]; then
      echo "Failed to start Mendix build. Check the API response for errors."
      exit 1
    fi
    
    # This line makes the build_id available to subsequent steps in the pipeline
    echo "build_id=$build_id" >> $GITHUB_OUTPUT
    echo "Build ID is $build_id"
    
    # Poll the Mendix API to check the build status every 10 seconds until it's finished
    status="BUILDING"
    while [ "$status" != "SUCCEEDED" ] && [ "$status" != "FAILED" ]
    do
      echo "Current build status: $status"
      sleep 10
      build_status_response=$(curl 'https://deploy.mendix.com/api/1/apps/${{ secrets.MENDIX_APP_ID }}/packages/${build_id}' \
        --header 'Mendix-Username: ${{ secrets.MENDIX_USERNAME }}' \
        --header 'Mendix-ApiKey: ${{ secrets.MENDIX_API_KEY }}')
      
      status=$(echo "$build_status_response" | jq -r '.status')
    done
    
    # If the build fails, the pipeline will stop here and report an error
    if [ "$status" == "FAILED" ]; then
      echo "Mendix build failed."
      exit 1
    fi